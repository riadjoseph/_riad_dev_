{"version":3,"file":"mutation-rate-limiter.js","sourceRoot":"","sources":["../../../../src/extensions/replay/mutation-rate-limiter.ts"],"names":[],"mappings":"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","sourcesContent":["import type { eventWithTime, mutationCallbackParam } from '@rrweb/types'\nimport { INCREMENTAL_SNAPSHOT_EVENT_TYPE, MUTATION_SOURCE_TYPE } from './sessionrecording-utils'\nimport type { rrwebRecord } from './types/rrweb'\n\nimport { clampToRange } from '../../utils/number-utils'\n\nexport class MutationRateLimiter {\n    private _bucketSize = 100\n    private _refillRate = 10\n    private _mutationBuckets: Record<string, number> = {}\n    private _loggedTracker: Record<string, boolean> = {}\n\n    constructor(\n        private readonly _rrweb: rrwebRecord,\n        private readonly _options: {\n            bucketSize?: number\n            refillRate?: number\n            onBlockedNode?: (id: number, node: Node | null) => void\n        } = {}\n    ) {\n        this._refillRate = clampToRange(\n            this._options.refillRate ?? this._refillRate,\n            0,\n            100,\n            'mutation throttling refill rate'\n        )\n        this._bucketSize = clampToRange(\n            this._options.bucketSize ?? this._bucketSize,\n            0,\n            100,\n            'mutation throttling bucket size'\n        )\n        setInterval(() => {\n            this._refillBuckets()\n        }, 1000)\n    }\n\n    private _refillBuckets = () => {\n        Object.keys(this._mutationBuckets).forEach((key) => {\n            this._mutationBuckets[key] = this._mutationBuckets[key] + this._refillRate\n\n            if (this._mutationBuckets[key] >= this._bucketSize) {\n                delete this._mutationBuckets[key]\n            }\n        })\n    }\n\n    private _getNodeOrRelevantParent = (id: number): [number, Node | null] => {\n        // For some nodes we know they are part of a larger tree such as an SVG.\n        // For those we want to block the entire node, not just the specific attribute\n\n        const node = this._rrweb.mirror.getNode(id)\n\n        // Check if the node is an Element and then find the closest parent that is an SVG\n        if (node?.nodeName !== 'svg' && node instanceof Element) {\n            const closestSVG = node.closest('svg')\n\n            if (closestSVG) {\n                return [this._rrweb.mirror.getId(closestSVG), closestSVG]\n            }\n        }\n\n        return [id, node]\n    }\n\n    private _numberOfChanges = (data: Partial<mutationCallbackParam>) => {\n        return (\n            (data.removes?.length ?? 0) +\n            (data.attributes?.length ?? 0) +\n            (data.texts?.length ?? 0) +\n            (data.adds?.length ?? 0)\n        )\n    }\n\n    public throttleMutations = (event: eventWithTime) => {\n        if (event.type !== INCREMENTAL_SNAPSHOT_EVENT_TYPE || event.data.source !== MUTATION_SOURCE_TYPE) {\n            return event\n        }\n\n        const data = event.data as Partial<mutationCallbackParam>\n        const initialMutationCount = this._numberOfChanges(data)\n\n        if (data.attributes) {\n            // Most problematic mutations come from attrs where the style or minor properties are changed rapidly\n            data.attributes = data.attributes.filter((attr) => {\n                const [nodeId, node] = this._getNodeOrRelevantParent(attr.id)\n\n                if (this._mutationBuckets[nodeId] === 0) {\n                    return false\n                }\n\n                this._mutationBuckets[nodeId] = this._mutationBuckets[nodeId] ?? this._bucketSize\n                this._mutationBuckets[nodeId] = Math.max(this._mutationBuckets[nodeId] - 1, 0)\n\n                if (this._mutationBuckets[nodeId] === 0) {\n                    if (!this._loggedTracker[nodeId]) {\n                        this._loggedTracker[nodeId] = true\n                        this._options.onBlockedNode?.(nodeId, node)\n                    }\n                }\n\n                return attr\n            })\n        }\n\n        // Check if every part of the mutation is empty in which case there is nothing to do\n        const mutationCount = this._numberOfChanges(data)\n\n        if (mutationCount === 0 && initialMutationCount !== mutationCount) {\n            // If we have modified the mutation count and the remaining count is 0, then we don't need the event.\n            return\n        }\n        return event\n    }\n}\n"]}